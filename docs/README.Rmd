---
title: "STAR alignments for 14980R"
date: '`r gsub("  ", " ", format(Sys.time(), "%B %e, %Y"))`'
output:
  html_document:
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, comment="", collapse=TRUE)
```

This guide describes the steps used to run [STAR] alignments on the Fastq files
in GNomEx. All the scripts listed in steps #2-#6 are organized in a `cmd.txt`
file,  which is used to send jobs to the [CHPC] clusters following the [Pysano]
reference manual.  This file also includes [shell] commands to parse sample
names from FASTQ files and then read and write to different output files with
that prefix.

###1. Create reference

Download the human FASTA and GTF file from [Ensembl] release 92 and
run [STAR] with the `genomeGenerate` option to create the reference database.
The `sjdbGTFfile` option extracts splice junctions from the GTF file with a
maximum possible overhang of 49 bases (for 50 bp reads).

```{bash star_ref, eval=FALSE}
wget ftp://ftp.ensembl.org/pub/release-92/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
wget ftp://ftp.ensembl.org/pub/release-92/gtf/homo_sapiens/Homo_sapiens.GRCh38.92.gtf.gz
gunzip *.gz

STAR --runMode genomeGenerate \
     --databaseDir star50 \
     --runThreadN 24 \
     --databaseFastaFiles Homo_sapiens.GRCh38.dna.primary_assembly.fa \
     --sjdbGTFfile Homo_sapiens.GRCh38.92.gtf \
     --sjdbOverhang 49
```

###2. Trim adapters

Trim the Illumina adpater sequence using [cutadapt] version 1.16.  The -O
option starts trimming after 6 matching bases and -m option will discard trimmed
reads shorter than 20 bases

```{bash cutadapt, eval=FALSE}
cutadapt -j 24 -O 6 -m 20 -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCA -o 14980X1.fq test123.fq
```

###3. Run FastQC

Run [FastQC] on the trimmed fastq file.  This ouputs sequence length distributions,
overrepresented sequences and many other statistics.

```{bash fastq, eval=FALSE}
fastqc -f fastq 14980X1.fq
```

###4. Align reads

Align the trimmed reads using [STAR] version 2.5.4a_version to the human
star50 database in two pass mode and output a BAM file sorted by
coordinates and unstranded bedGraph file.

```{bash star_run, eval=FALSE}
STAR --databaseDir star50 \
     --runThreadN 24 \
     --readFilesIn 14980X1.fq \
     --twopassMode Basic \
     --outSAMtype BAM SortedByCoordinate \
     --outWigType bedGraph \
     --outWigStrand Unstranded
```

###5. Count features

Rename the STAR output BAM file and run [featureCounts] version 1.5.1 to count
aligned reads  overlapping features in the GTF file. The default is to ignore
multi-mapping reads or reads overlapping two or more features, but these counts
can be added using `-M --fraction` and `--largestOverlap`.

```{bash counts, eval=FALSE}
mv Aligned.sortedByCoord.out.bam $OUT.bam
featureCounts -T 24 -s 2 -a Homo_sapiens.GRCh38.92.gtf 14980X1.counts 14980X1.bam
```

###6. Check quality

Run Picard [CollectRnaSeqMetrics] to count the number of reads matching exons,
UTRs, introns and intergenic regions and to calculate the normalized gene
coverage from the top 1000 expressed transcripts. Finally, run [samtools idxstats] to
count the number of reads per chromosome.

###7. Summarize alignment statistics

[MultiQC] searches the Alignments directory for analysis logs and compiles an
HTML report that includes interactive summary tables and plots for all commands
in the `cmd.txt` file.

```{bash multiqc, eval=FALSE}
multiqc Alignments
```

The General Statistics table at the top of the report includes summaries from
FastQC like total sequences (M Seqs), STAR (M Aligned), featureCounts (M
Assigned) and collectRNASeqMetrics (% rRNA and mRNA).   The remaining sections
summarize outputs from each program.

###5.  View alignments

Load a BAM file into a database browser like [IGV] by clicking the URL link icon
next to the BAM file name in GNomEx.   Copy and paste the link into IGV by
selecting "File, Load from URL".   Search for a gene or zoom into a specific
region to check alignments. If reads do not align with annotations, make sure
the correct reference assembly is selected (hg38, mm10, rn6, etc.).  Also, for
stranded Illumina single read sequencing runs, the reads in the BAM file will
align in the opposite direction of the feature,  so the `-s 2` option in
`featureCounts` was used to count reversely stranded reads.

To compare many samples, it's easier to load the bigWig files in GNomEx. The
STAR aligner normalizes coverage files by default, so the units are reads per
million mapped reads (RPM). In addition, separate coverage files are created for
unique reads (\*.unique.bw) and unique plus multi-mapping reads
(\*.multiple.bw).

[IGV] displays a normalized coverage plot and RPM values at each position on the
database.  If needed, multiply the RPM by the number of unique alignments from
STAR in the [MultiQC] file to get the total reads at that base (for example,
24.45863 RPM * 21873674 uniquely aligned reads/1000000 = 535 total reads).
Finally, select multiple tracks and right click to set the same minimun and
maximum values to display in the y-axis range by selecting Group Autoscale.

###6. Differential Expression

See the `DESeq.html` report for further details on the differential expression analysis.

<br>

[cutadapt]: http://cutadapt.readthedocs.io/en/stable/index.html
[STAR]: https://github.com/alexdobin/STAR
[Ensembl]: http://uswest.ensembl.org/info/data/ftp/index.html
[Pysano]: http://healthcare.utah.edu/huntsmancancerinstitute/research/shared-resources/center-managed/bioinformatics/pysano
[CHPC]: https://www.chpc.utah.edu/
[shell]: http://tldp.org/LDP/abs/html/index.html
[IGV]: http://software.broadinstitute.org/software/igv/
[featureCounts]: http://bioinf.wehi.edu.au/featureCounts/
[FastQC]: http://www.bioinformatics.babraham.ac.uk/projects/fastqc/
[CollectRnaSeqMetrics]: https://broadinstitute.github.io/picard/command-line-overview.html#CollectRnaSeqMetrics
[samtools idxstats]: http://www.htslib.org/
[MultiQC]: http://multiqc.info/
